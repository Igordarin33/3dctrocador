                                                  # --- Pinagem ---
[respond]
[virtual_pins]

[output_pin troca_cor]
pin: PA0
pwm: False
value: 0 # pino mestre que ativa o Arduino ‚Äî sem ele, nenhuma a√ß√£o de troca √© poss√≠vel
shutdown_value: 0

[output_pin descarga_purga]
pin: PB0
pwm: False
value: 0 # ativa o servo da descarga de filamento ‚Äî aproveita porta PB0 (antes usada para LED)
shutdown_value: 0

[output_pin KIT_CFS]
pin: virtual_pin:KIT_CFS_pin
pwm: False
value: 0 #Valor 1 para kit UPGRADE CFS (cortador e descarga) 


[output_pin ABAIXAR_TEMP_PAUSE]
pin: virtual_pin:ABAIXAR_TEMP_PAUSE_pin
pwm: False
value: 0 #responsavel por abaixar ou n√£o, a temperatura durante o PAUSE

[gcode_macro AJUSTA_TEMPERATURA]
description: Evita que a temperatura seja abaixada para $140¬∞c durante o pause
gcode:
  {% if printer["output_pin ABAIXAR_TEMP_PAUSE"].value == 1 %}
    M104 S{printer.extruder.target}   ; mant√©m temperatura da impress√£o
    M118 "Temperatura mantida"
  {% else %}
    M104 S140                         ; reduz para 140¬∞C
  {% endif %}



#================================================================================================================================================================================================================

                                                   # --- Variaveis ---
[gcode_macro VARIAVEIS_TURBO]
# TEMPO E CONTROLE
variable_pulso: 550              # tempo do pulso (ms) = alvo * pulso ‚Äî controla a resposta do Arduino
variable_aguardar: 3000          # espera entre comandos do Arduino (ms) ‚Äî muito baixo pode causar erros
variable_saidahub: 3000          # tempo para o filamento percorrer ap√≥s sensor traseiro, ajusta posi√ß√£o no hub
variable_extrusaodatroca: 30     # mm de filamento empurrado na troca para garantir travamento na extrusora
variable_temperaturabico: 230    # temperatura do bico em trocas ou idle
variable_tirambaco: 100          # Retra√ß√£o extra do filamento ao trocar, para melhorar a retirada combinada com o arduino

# POSI√á√ÉO DO CARRINHO
variable_eixox: 228.94           # posi√ß√£o X para remover filamento
variable_eixoy: -0.49            # posi√ß√£o Y para remover filamento

# POSI√á√ÉO DA PURGA CASO NAO USE KIT CFS
variable_x_purga: -5.0           # X da purga
variable_y_purga: 141.13         # Y da purga
variable_z_purga: 37.0           # Z da purga, evitar bater no bico

# LIMPEZA INICIAL
variable_limpezainicial: 100     # filamento extrusado na primeira purga, evita contamina√ß√£o da primeira camada
gcode:
  M118 "VARIAVEIS_TURBO carregado"
  
#KIT CFS
variable_retrairecortar: 20      # retra√ß√£o antes de cortar o filamento(guilhotina) (nao  pode s er muito, senao  gera entupimento na  troca)
variable_poscorte: 30            # remove o filamento depois do corte, deixando ele livre para ser puxado 

#TESTE DE TROCA 
variable_delay: 30000            # tempo entre as trocas

#================================================================================================================================================================================================================

  
#                             ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó
#                            ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó    ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù
#                            ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë       ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë    ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù 
#                            ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë       ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó 
#                            ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù       ‚ñà‚ñà‚ïë   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù    ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó
#                             ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù        ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù                                                                                                                                                                                                                                                                                                                                                                        
#                                                                      @@@@@@        ::mm                                                                        
#                                                                      @@@@@@@@@@    mmmmmm  mmmm          mm..                                                  
#                                                                      @@@@@@@@@@@@  mmmmmmmmmmmm  --      mmmm..--                                              
#                                                                      @@@@@@mm                    ..      mmmmmm....                                            
#                                                          mmmmmmmm    ::      --------------------      ::mmmmmm++....                                          
#                                                          mmmmmmmmmm    ::----------------------------  mmmmmmmmmm++..--                                        
#                                                          mmmmmmmm  --  --------mmmmmmmmmmmmmmmmmmmm    MMMMmmmmmmmmmm..                                        
#                                                            mm@@  mmmm++  mmmmmmmmmmmmmmmmmmmmmmmmmm  MMMMMMMMMM++mmmmmm..                                      
#                                                                mmmm++++..  mmmmmmmmmmmmmmmmmmmmmmMMMMMMMMMMMMMMMMmm++++..                                      
#                                                    @@@@@@--  mmmmmm++@@@@  mmmmmmmmmmmmmmmmmmmmmm  MMMMMMMMMMMM    ..mmmm                                      
#                                                    @@@@@@  mmmm++++@@@@@@@@  mmmmmmmmmmmmmmmmmmmm  MMMMMMMMMM  @@MMmm  mm--                                    
#                                                      @@    mmmmmm@@@@@@@@@@    mmmmmmmmmmmmmmmmmm  MMMMMMMM  mm  MMMM  mm..                                    
#                                                      ..  mmmmmm++@@@@@@@@@@@@  mmmmmmmmmmmmmmmmmm  MMMMMMMM  MMMM  @@##mm..                                    
#                                                MM@@@@MM..mmmmmm@@@@@@@@@@@@@@    mmmmmmmmmmmmmmmm  MMMMMMMM    ..MM@@  mmmm                                    
#                                                @@@@@@  mmmmmmmm@@@@@@@@@@@@@@@@  mmmmmmmmmmmmmmmm  MMMMMMMMMM  @@@@@@  mmmm                                    
#                                                  @@@@  mmmmmm##@@@@@@@@@@@@@@@@                      MMMMMMMMMM    @@MM++mm                                    
#                                                    ##--mmmm++@@@@@@@@@@@@@@@@@@                        MMMMMMMMMMMMMMMMmm--                                    
#                                                          mmmm@@@@@@@@@@@@@@@@  @@@@@@                    MMMMMMMMMMMMMMmm                                      
#                                                ++++  mmmm      @@@@@@@@@@@@  @@@@@@@@@@                    MMMMMMMMMMMM++                                      
#                                              ::++++  mmmmmmmm@@        ##    ..@@@@@@@@@@                      MMMMMMMMmm                                      
#                                                  ++  mmmmmmmm@@@@@@@@          @@@@@@@@@@@@                        MMmm                                        
#                                                      mmmmmmmm@@@@@@@@@@      --@@@@@@@@@@@@@@@@@@                                                              
#                                                  ::  mmmmmmmm@@@@@@@@@@      @@@@@@@@@@@@@@@@@@@@@@@@                                                          
#                                                ::::  mmmmmmmm@@@@@@@@@@      --        @@@@@@@@@@                                                              
#                                                  ++++++mmmmmm@@@@@@@@@@                    ..@@@@@@                                                            
#                                                        mmmmmmmm@@@@@@@@                          @@                                                            
#                                                    MM  mmmmmmmm@@@@@@@@                                                                                        
#                                                  MMMM@@@@mmmmmmmm@@@@                                                                                          
#                                                          mmmmmmmmMM            MM@@@@@@@@@@##                                                                  
#                                                      ##--@@mm++  ..MMMMMM  @@@@@@@@@@@@@@@@@@                                                                  
#                                                      ####    ++::::::MMMM@@@@@@@@@@@@mm                                                                        
#                                                              ::::::::::MMMM                                                                                    
#                                                          ##@@  ::::::::::MMMM                                                                                  
#                                                          @@@@  ..::::::::MMMMMM                        MM                                                      
#                                                                ::  ::MMMMMMMMMM  @@@@@@@@@@@@@@@@@@@@                                                          
#                                                                mm      MMMMMM@@@@@@@@@@@@@@@@@@@@@@                                                            
#                                                                    mm        @@@@@@@@@@@@@@@@##                                                                
#                                                                          --  @@                                                                                
                                                                                                                                                                

                                                                                                                                                                
                                                                                                                                                                
                                                                                                                                                                
                                                                                                                                                                
                                                                                                                                                                
                                                                                                                                                                
                       
                                                  # --- Sensores Clicks! ---    
 

# Detecta a chegada do filamento na extrusora principal.
# - Quando a vari√°vel est√° em 0, o filamento √© sempre enviado pelo comando do sensor.
# - Fora isso, a macro ESCOLHER controla o envio do filamento automaticamente.
# - O outro sensor s√≥ entra em a√ß√£o quando √© necess√°ria a troca de filamento.
[filament_switch_sensor filament_sensor_2]                                    # <-- Sensor da extrusora
pause_on_runout: false
switch_pin: !nozzle_mcu:PA10
event_delay: 1.5
pause_delay: 0.25
insert_gcode:
  {% set is_paused = printer.print_stats.state == "paused" %}
  {% set temperaturabico = printer["gcode_macro VARIAVEIS_TURBO"].temperaturabico|int %}
  {% set extrusaodatroca = printer["gcode_macro VARIAVEIS_TURBO"].extrusaodatroca|int %}
  # --- Checagens antes de qualquer a√ß√£o ---
  #{% if "x" not in printer.toolhead.homed_axes or
  #     "y" not in printer.toolhead.homed_axes or
  #     "z" not in printer.toolhead.homed_axes %}
  #  _OFF_
  #  M118 "Homing necess√°rio "
  # G28
  # Substiuido pela Macro do Creality IF_NEED_HOME
  IF_NEED_HOME

  {% endif %}
  {% if printer.extruder.temperature < 200 %}
    {% if printer.extruder.temperature < temperaturabico %}
      _OFF_
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temperaturabico}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temperaturabico}
    {% endif %}
    G1 E{extrusaodatroca} #pux√£o para travar a extrusora antes do motor para de empurrar
  {% endif %}
  _OFF_  # <-- desativa o envio de filamento    


 --- Verifica o modo de recep√ß√£o do filamento --- 
  DESCARGA_CFS # <-- move para descarga        ##
  {% if printer["output_pin KIT_CFS"].value == 1 %}
         # <-- move para descarga         
      BOX_MATERIAL_FLUSH LEN=90 VELOCITY=360 TEMP={temperaturabico}  # <-- carrega o filamento e  faz  Limpeza  
      {% else %}
          LOAD_MATERIAL                                  ##
          LIMPEZA_CFS    # <-- limpa a descarga          ##

  {% endif %}    
  {% if is_paused %}
      G4 P100
      RESUME
  {% endif %}
runout_gcode:
  M118 ">> Filamento acabou!"
  {% set printing = printer.idle_timeout.state == "Printing" %}
  {% if printing %}
    PAUSE
  {% endif %}
  M118 "filament runout"
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E-30 F180
    G1 E-50 F2000
    G90
  {% endif %}

# Detecta a sa√≠da do filamento.
# - Quando a macro ESCOLHER retira o filamento, este sensor atualiza a vari√°vel com +100 para indicar que √© necess√°rio carregar o pr√≥ximo.
# - √â o sensor principal de controle: ao detectar a sa√≠da, dispara o envio do novo filamento com o comando _ON_.
[filament_switch_sensor filament_sensor]                                     # <-- Sensor traseiro
pause_on_runout: false
switch_pin: PC15
event_delay: 1.5  # <-- esse valor √© acumulativo com o saidahub, 1.5 segundos + saidahub(2s) = 3.5segundos
pause_delay: 0.25
insert_gcode:
  {% set aguardar = printer["gcode_macro VARIAVEIS_TURBO"].aguardar|int %}
  {% set saidahub = printer["gcode_macro VARIAVEIS_TURBO"].saidahub|int %}
  {% set estado = printer["gcode_macro PULSAR"].alvo|int %}
  {% set desc_list = ["","Extrusora T0","Extrusora T1","Extrusora T2","Extrusora T3","Extrusora T4","Extrusora T5","Extrusora T6","Extrusora T7","Carregar/Inicio T0","Descarregar/Inicio","Inicio","Pr√≥ximo","Aleat√≥rio","Pulso Extra"] %}
  G4 P{saidahub} #tempo de saida do hub, esse valor define quanto tempo ele continua enviando o filamento, ap√≥s o sensor detectar a saida
  _OFF_  # <-- desliga o filamento sendo retirado
  
  {% if estado >= 100 and estado <= 108 %}  #Se havia uma pend√™ncia marcada (100 + N), ativa o trocador para puxar o filamento
    {% set confirmado = estado - 100 %}
    {% if confirmado >= 1 and confirmado <= 8 %} #transforma a variavel para uma extrusora real, 101-100 = T0
      {% set nome = desc_list[confirmado] %}
      RESPOND TYPE=command MSG="Sensor:Remo√ß√£o detectada ‚Äî pendente {nome}"
      SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE={confirmado}
      G4 P{aguardar}
      _ON_ #envia o novo filamento
    {% else %}
      RESPOND TYPE=error MSG=" Sensor: estado pendente inv√°lido estado={estado}"
      _OFF_
    {% endif %}
  {% else %} 
    {% set nome_atual = (desc_list[estado] if (estado >= 0 and estado <= 14) else "??") %} # sem pend√™ncia ‚Äî n√£o ativa o trocador
    RESPOND TYPE=command MSG=" Sensor:Sem pend√™ncia. Estado atual: {nome_atual}"
  {% endif %}
runout_gcode:


                                                  # --- L√≥gica Principal ---
                                                  
[gcode_macro PULSAR]
description: Envia o pulso N (1‚Äì14). Macro crua: s√≥ atualiza vari√°vel e pulsa o pino para o arduino.
variable_alvo: -1
gcode:
  {% set pulso = printer["gcode_macro VARIAVEIS_TURBO"].pulso|int %}
  {% set novo_alvo = params.N|int %}
  {% if novo_alvo < 1 or novo_alvo > 14 %} # Valida√ß√£o simples (1..14)
    RESPOND TYPE=error MSG="Pulso {novo_alvo} inv√°lido escolha um n√∫mero entre 1 e 14"
  {% else %}
    SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE={novo_alvo}
    {% set tempo = novo_alvo * pulso %}  
    _ON_
    G4 P{tempo}
    _OFF_
  {% endif %}

[gcode_macro ESCOLHER]
description: Troca autom√°tica de filamento com descarregamento se necess√°rio.
variable_novo_alvo: 0
gcode:
  {% set tirambaco = printer["gcode_macro VARIAVEIS_TURBO"].tirambaco|int %}
  {% set poscorte = printer["gcode_macro VARIAVEIS_TURBO"].poscorte|int %}
  {% set temperaturabico = printer["gcode_macro VARIAVEIS_TURBO"].temperaturabico|int %}
  {% set is_paused = printer.print_stats.state == "paused" %}
  {% set is_printing = printer.print_stats.state == "printing" %}
  {% set novo_alvo = params.N|int %}
  {% set temperaturabico = printer["gcode_macro VARIAVEIS_TURBO"].temperaturabico|int %}
  {% set atual = printer["gcode_macro PULSAR"].alvo|int %}
  {% if is_printing %}
     PAUSE
    {% if printer.extruder.temperature < temperaturabico %}
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temperaturabico}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temperaturabico}
    {% endif %}
  {% endif %}
  # --- Corrige caso atual esteja bugado (100+N) --- #
  {% if atual >= 100 and atual <= 108 %}
    {% set corrigido = atual - 100 %}
    RESPOND TYPE=error MSG="Ops, deu ruim a√≠,(n√£o carregou o filamento n√©? hahaha üòÖ) mas j√° estou resolvendo! Al√©m disso vou resetar o Arduino e fazer o homing, blz?"
    RESPOND TYPE=error MSG="Confira se o Arduino est√° em 'PRONTO!' e se n√£o h√° nenhum filamento carregado. Deixe todos os filamentos preparados para serem inseridos."
    TURBORESET
    PULSAR N=11
    RESPOND TYPE=command MSG="Realizando Homing do Arduino..."
    SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=0
    {% set atual = 0 %}
  {% endif %}
  {% set pulso = printer["gcode_macro VARIAVEIS_TURBO"].pulso|int %}
  {% set aguardar = printer["gcode_macro VARIAVEIS_TURBO"].aguardar|int %}
  {% set desc_list = ["","Extrusora T0","Extrusora T1","Extrusora T2","Extrusora T3","Extrusora T4","Extrusora T5","Extrusora T6","Extrusora T7","Carregar/Inicio T0","Descarregar/Inicio","Inicio","Pr√≥ximo","Aleat√≥rio","Pulso Extra"] %}
  {% set desc_novo = desc_list[novo_alvo] if (1 <= novo_alvo <= 14) else "??" %}
  {% set desc_atual = desc_list[atual] if (0 <= atual <= 14) else "??" %}

  
  # --- Checagens antes de qualquer a√ß√£o ---
  # --- HOME X, Y, Z ---
  {% if "x" not in printer.toolhead.homed_axes or
        "y" not in printer.toolhead.homed_axes or
        "z" not in printer.toolhead.homed_axes %}
    _OFF_
    M118 "Home XYZ necess√°rio - executando G28"
    G28
  {% endif %}
  # --- Pr√© aquecimento ---
  {% if printer.extruder.temperature < 200 %}
    {% if printer.extruder.temperature < temperaturabico %}
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temperaturabico}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temperaturabico}
    {% endif %}
  {% endif %}

# --- A m√°gica acontece aqui em baixo: ---

# --- Se for -1(alvo) e n√£o for 9, 10, 11, realizar Homing inicial(arduino)  ---
  {% if atual == -1 and novo_alvo not in [9,10,11] %}
    M118 Realizando Homing inicial antes da troca...
    RESPOND TYPE=command MSG="Realizando Homing do Arduino..."
    {% set homing = 11 * pulso %}
    G4 P{aguardar}
    _ON_
    G4 P{homing}
    _OFF_
    G4 P{aguardar}
    SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=0
    {% set atual = 0 %} # <-- for√ßa a vari√°vel local
  {% endif %}
  
# --- Se for pulso 11 realizar o homing ---
  {% if novo_alvo == 11 %} #  
    G4 P{aguardar}
    PULSAR N=11
    G4 P{aguardar}
    SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=0
    {% set atual = 0 %} # <-- for√ßa a vari√°vel local
    
# --- Se for pulso 10 (homing e descarregar) ---
  {% elif novo_alvo == 10 %} 
    {% if atual == 0 %}
      M118 Nenhum filamento carregado, nada a descarregar.
    {% else %}
      {% if printer["output_pin KIT_CFS"].value == 1 %}
            DESCARGA_CFS
            RETRAIR_CORTAR  # <-- retrai antes do corte     ## 
            BOX_CUT_MATERIAL       # <-- corta o filamento         ##
            G1 E-{poscorte} # <-- retira o filamento da extrusora
          {% else %}
            DESCARGA_CFS   # <-- move para descarga        ##
            QUIT_MATERIAL                                  ##
            LIMPEZA_CFS    # <-- limpa a descarga          ##
          {% endif %}
      RESPOND TYPE=command MSG="{desc_novo} ..."
      G4 P{aguardar}
      PASSO_FRENTE
      PULSAR N=10 
      G4 P{aguardar}
      _ON_ #descarrega
      G1 E-100 F3000
      G92 E0
      RESPOND TYPE=command MSG="Sem filamento"
      SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=0
      {% set atual = 0 %} # <-- for√ßa a vari√°vel local
    {% endif %}


# --- Se for pulso 9 (homing e carregar t0) ---    
  {% elif novo_alvo == 9 %}
    {% if atual == 1 %}
      M118 {desc_novo} j√° est√° carregada, nada a fazer.
      {% if printer.print_stats.state == "paused" %}
         G4 P100
         RESUME
      {% endif %}
    {% else %}
      RESPOND TYPE=command MSG="{desc_novo} ..."
      DESCARGA_CFS
      G4 P{aguardar}
      PULSAR N=11 
      G4 P{aguardar}
      _ON_
      SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=1
      {% if printer.print_stats.state == "paused" %}
         G4 P100
         RESUME
      {% endif %}
      {% set atual = 1 %} # <-- for√ßa a vari√°vel local
    {% endif %}
  {% else %}


# --- Restante do c√≥digo s√≥ roda se n√£o for 9,10,11 ---
    {% if novo_alvo < 1 or novo_alvo > 14 %} # 
      M118 ERRO: Pulso {desc_novo} inv√°lido! Escolha:
      M118 1: Extrusora T0
      M118 2: Extrusora T1
      M118 3: Extrusora T2
      M118 4: Extrusora T3
      M118 5: Extrusora T4
      M118 6: Extrusora T5
      M118 7: Extrusora T6
      M118 8: Extrusora T7
      M118 9: Carregar/Inicio T0
      M118 10: Descarregar/Inicio
      M118 11: Inicio
      M118 12: Pr√≥ximo
      M118 13: Aleat√≥rio
      M118 14: Pulso Extra
      RESPOND TYPE=error MSG="Pulso inv√°lido"
    {% else %}
      {% set desc_novo = desc_novo %}
      {% set desc_atual = desc_atual %}

      
# --- Se j√° carregado o filamento pedido, nao fazer nada ---
      {% if atual == novo_alvo %}  
        M118 {desc_novo} j√° est√° carregada, nada a fazer.
        {% if is_paused %}
         RESUME
        {% endif %}

# --- Se n√£o tem filamento carregado (0), s√≥ carregar o novo ---
      {% elif atual == 0 %} 
        G4 P{aguardar}
        RESPOND TYPE=command MSG="Nenhum filamento carregado, carregando {desc_novo} ..."
        PULSAR N={novo_alvo}
        G4 P{aguardar}
        _ON_

# --- Se tem outro filamento carregado, descarregar e carregar o novo ---
      {% else %} # 
        G4 P{aguardar}
        M118 Descarregando {desc_atual} antes de carregar {desc_novo}...
        G4 P{aguardar}
        {% if printer["output_pin KIT_CFS"].value == 1 %}
            RETRAIR_CORTAR  # <-- retrai antes do corte     ##
            BOX_CUT_MATERIAL       # <-- corta o filamento         ##
            G1 E-{poscorte} # <-- retira o filamento da extrusora
          {% else %}
            DESCARGA_CFS   # <-- move para descarga        ##
            QUIT_MATERIAL                                  ##
            LIMPEZA_CFS    # <-- limpa a descarga          ##
          {% endif %}
        G4 P{aguardar}
        PASSO_FRENTE    
        PULSAR N={novo_alvo} # <--  escolhe a pr√≥xima extrusora
        G4P{aguardar}
        _ON_ # <-- remove o filamento
        G1 E-{tirambaco} F3000 # <--enquando o trocador puxa, a extrusora empurra
        G92 E0
        SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE={100 + novo_alvo}
      {% endif %}
    {% endif %}
  {% endif %}




                                                  # --- Controle Geral ---

[gcode_macro _OFF_]
description: Desliga o bot√£o
gcode:
  SET_PIN PIN=troca_cor VALUE=0
[gcode_macro _ON_]
description: Liga o bot√£o
gcode:
  SET_PIN PIN=troca_cor VALUE=1

[gcode_macro T0]
description: Carrega o filamento da extrusora T0
gcode:
  ESCOLHER N=1

[gcode_macro T1]
description: Carrega o filamento da extrusora T1
gcode:
  ESCOLHER N=2
  
[gcode_macro T2]
description: Carrega o filamento da extrusora T2
gcode:
  ESCOLHER N=3
  
[gcode_macro T3]
description: Carrega o filamento da extrusora T3
gcode:
  ESCOLHER N=4
  
[gcode_macro T4]
description: Carrega o filamento da extrusora T4
gcode:
  ESCOLHER N=5
  
[gcode_macro T5]
description: Carrega o filamento da extrusora T5
gcode:
  ESCOLHER N=6
  
[gcode_macro T6]
description: Carrega o filamento da extrusora T6
gcode:
  ESCOLHER N=7

[gcode_macro T7]
description: Carrega o filamento da extrusora T7
gcode:
  ESCOLHER N=8

[gcode_macro DESCARREGAR_ATUAL]
description: Carrega o filamento da extrusora T7
gcode:
  ESCOLHER N=10
  {% if printer.print_stats.state == "paused" %}
     G4 P100
     RESUME
  {% endif %}

[gcode_macro TURBORESET]
description: Configura√ß√£o de reset do arduino, permanecendo "pronto!"
gcode:
  {% for i in range(3) %}
    _ON_
    G4 P300
    _OFF_
    G4 P300
  {% endfor %}
  G4 P150
  RESPOND TYPE=command MSG="Resetando o arduino..."



                                                  # --- Impress√£o ---
                                                  
[gcode_macro INICIO_ORCA]
description: Configura√ß√£o inicial antes da impress√£o
gcode:
  SET_PIN PIN=ABAIXAR_TEMP_PAUSE VALUE=1
  SET_PIN PIN=descarga_purga VALUE=0
  M118 "Preparando..."
  M82     
  M106 S0     
  M106 P1 S0   
  M106 P2 S0   
  G90         
  TURBORESET 
  G4 P1000

[gcode_macro NANAR]
description: Finaliza a impress√£o e realiza a remo√ß√£o do filamento
gcode:
  PAUSE
  G92 E0               
  G90               
  BEEP             
  BEEP
  ESCOLHER N=10
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=-1
  {% set atual = -1 %}
  {% if printer.print_stats.state == "paused" %}
     G4 P100
     RESUME
  {% endif %}

[gcode_macro CANCEL_PRINT]
description: Cancela a impress√£o atual e realiza a remo√ß√£o do filamento
rename_existing: CANCEL_PRINT_BASE
gcode:
  G0 E-2 F2400       
  G92 E0             
  TURBORESET
  ESCOLHER N=10
  END_PRINT          
  CANCEL_PRINT_BASE
  SET_GCODE_VARIABLE MACRO=PULSAR VARIABLE=alvo VALUE=-1
  {% set atual = -1 %}





                                                  # --- Kit CFS / Compativel ---

[gcode_macro POSICIONAR]
description: Move o bico para a posi√ß√£o de purga
gcode:
    {% set x_purga = printer["gcode_macro VARIAVEIS_TURBO"].x_purga|float %}
    {% set y_purga = printer["gcode_macro VARIAVEIS_TURBO"].y_purga|float %}
    G0 X{x_purga} Y{y_purga} F15000
    SET_PIN PIN=descarga_purga VALUE=1
    G4 P400
    G92 E0



[gcode_macro DESCARGA_CFS]
description: Move o carrinho para a descarga do filamento, aguardando realizar a purga.
gcode:
  {% if printer["output_pin KIT_CFS"].value == 1 %}
    BOX_GO_TO_EXTRUDE_POS # Vai para a  Posicao de purga
  {% else %}
    #posiciona o local da descarga customizado, diferente ou na mesma posi√ß√£o do CFS, preencher com comando para direcionar o carrinho ao local correto
    POSICIONAR
    G4 P400
  {% endif %}


[gcode_macro LIMPEZA_CFS]
description: Move o carrinho para frente e para tras, removendo qualquer dejeto(cocozinho) que tenha feito por meio da purga
gcode:
    #posiciona seu corte customizado, diferente ou na mesma posi√ß√£o do CFS, preencher com comando para direcionar o carrinho para cortar
    SET_PIN PIN=fan0 VALUE=255.00
    G4 P5000
    G1 E-1 F200
    {% for i in range(5) %}
      SET_PIN PIN=descarga_purga VALUE=0
      G4 P150
      SET_PIN PIN=descarga_purga VALUE=1
      G4 P150
    {% endfor %}
    SET_PIN PIN=descarga_purga VALUE=0
    SET_PIN PIN=fan0 VALUE=0.00
  {% endif %}


[gcode_macro RETRAIR_CORTAR]
description: Retrai uma quantidade especifica do filamento, antes de cortar, ajudando a economizar e acelerando o processo da purga
gcode:
  {% set retrairecortar = printer["gcode_macro VARIAVEIS_TURBO"].retrairecortar|int %}
  {% if printer["output_pin KIT_CFS"].value == 1 %}
    G1 E-{retrairecortar}
  {% else %}
    #igual o comando acima, ativar somente se utilizar outra guilhotina que n√£o seja do cfs
  {% endif %}

[gcode_macro PASSO_FRENTE]
description: Movimanta para eixox e eixoy
gcode:
  {% set eixox = printer["gcode_macro VARIAVEIS_TURBO"].eixox|float %}
  {% set eixoy = printer["gcode_macro VARIAVEIS_TURBO"].eixoy|float %}
  G0 X{eixox} Y{eixoy} F15000


                                                  # --- Testes ---

[gcode_macro TESTAR_TROCAS]
description: Testa automaticamente conjuntos de extrusoras (ESQ, DIR ou ALL).
# Uso:
#   TESTAR_TROCAS ALVO=ESQ   -> testa T0 a T3 
#   TESTAR_TROCAS ALVO=DIR   -> testa T4 a T7 4 extrusoras √ó 30s = 120 segundos = 2 minutos de teste
#   TESTAR_TROCAS ALVO=ALL   -> testa T0 a T7 8 extrusoras √ó 30s = 240 segundos = 4 minutos de teste


gcode:
  {% set alvo = params.ALVO|default("")|upper %}
  {% set delay = printer["gcode_macro VARIAVEIS_TURBO"].delay|int %}

  {% if alvo == "ESQ" %}
    M118 "Iniciando teste das 4 extrusoras da ESQUERDA (T0‚ÄìT3) ..."
    T0
    BEEP
    BEEP
    G4 P{delay}
    T1
    BEEP
    BEEP
    G4 P{delay}
    T2
    BEEP
    BEEP
    G4 P{delay}
    T3
    BEEP
    BEEP
    G4 P{delay}
    M118 "Teste concluido com sucesso!"


  {% elif alvo == "DIR" %}
    M118 "Iniciando teste das 4 extrusoras da DIREITA (T4‚ÄìT7) ..."
    T4
    BEEP
    BEEP
    G4 P{delay}
    T5
    BEEP
    BEEP
    G4 P{delay}
    T6
    BEEP
    BEEP
    G4 P{delay}
    T7
    BEEP
    BEEP
    G4 P{delay}

  {% elif alvo == "ALL" %}
    M118 "Iniciando teste de TODAS as 8 extrusoras (T0‚ÄìT7) ..."
    T0
    BEEP
    BEEP
    G4 P{delay}
    T1
    BEEP
    BEEP
    G4 P{delay}
    T2
    BEEP
    BEEP
    G4 P{delay}
    T3
    BEEP
    BEEP
    G4 P{delay}
    T4
    BEEP
    BEEP
    G4 P{delay}
    T5
    BEEP
    BEEP
    G4 P{delay}
    T6
    BEEP
    BEEP
    G4 P{delay}
    T7
    BEEP
    BEEP
    G4 P{delay}

  {% else %}
    M118 "‚ö†Ô∏è Op√ß√£o inv√°lida! Use: TESTAR_TROCAS ALVO=ESQ | DIR | ALL"
  {% endif %}


                                                  






